<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Data from API</title>
    <link rel="stylesheet" href="Stylesheet.css">
</head>
<body>
<h1 id="header">Cereal Database</h1>
<h2>Breakfast of Champions!</h2>

<div id="search-container">
    <div id="search-section">
        <form id="search-form">
            <input type="text" id="search-input" placeholder="Filter Cereals" />
            <button type="submit" id="search-button">Filter</button>
        </form>
    </div>
</div>

<div id="add-button">
    <button id="add-cereal-button" class="add-button">Add New Cereal</button>
</div>


<div id="error-message" style="color: red;"></div>
<div id="data-container"></div>

<div id="add-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 10px; width: 300px; text-align: center;">
        <h3>Update Cereal</h3>
        <form id="add-form">
            <div>
                <label for="cereal-name">Name:</label>
                <input type="text" id="add-cereal-name" name="name" />
            </div>
            <div>
                <label for="cereal-mfr">Manufacturer:</label>
                <input type="text" id="add-cereal-mfr" name="mfr" />
            </div>
            <div>
                <label for="cereal-type">Type:</label>
                <input type="text" id="add-cereal-type" name="type" />
            </div>
            <div>
                <label for="cereal-calories">Calories:</label>
                <input type="number" id="add-cereal-calories" name="calories" />
            </div>
            <div>
                <label for="cereal-protein">Protein:</label>
                <input type="number" id="add-cereal-protein" name="protein" />
            </div>
            <div>
                <label for="cereal-fat">Fat:</label>
                <input type="number" id="add-cereal-fat" name="fat" />
            </div>
            <div>
                <label for="cereal-sodium">Sodium:</label>
                <input type="number" id="add-cereal-sodium" name="sodium" />
            </div>
            <div>
                <label for="cereal-fiber">Fiber:</label>
                <input type="number" id="add-cereal-fiber" name="fiber" />
            </div>
            <div>
                <label for="cereal-carbo">Carbohydrates:</label>
                <input type="number" id="add-cereal-carbo" name="carbo" />
            </div>
            <div>
                <label for="cereal-sugar">Sugar (g):</label>
                <input type="number" id="add-cereal-sugar" name="sugar" />
            </div>
            <div>
                <label for="cereal-potass">Potassium:</label>
                <input type="number" id="add-cereal-potass" name="potass" />
            </div>
            <div>
                <label for="cereal-vitamins">Vitamins:</label>
                <input type="number" id="add-cereal-vitamins" name="vitamins" />
            </div>
            <div>
                <label for="cereal-shelf">Shelf:</label>
                <input type="number" id="add-cereal-shelf" name="shelf" />
            </div>
            <div>
                <label for="cereal-weight">Weight:</label>
                <input type="number" id="add-cereal-weight" name="weight" />
            </div>
            <div>
                <label for="cereal-cups">Cups:</label>
                <input type="number" id="add-cereal-cups" name="cups" />
            </div>
            <div>
                <label for="cereal-rating">Rating:</label>
                <input type="number" id="add-cereal-rating" name="rating" />
            </div>
            <div>
                <label for="cereal-image">Image URL:</label>
                <input type="text" id="add-cereal-image" name="image" />
            </div>
            <div style="margin-top: 10px;">
                <button type="button" id="save-cereal">Save</button>
                <button type="button" id="cancel-cereal">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="update-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 10px; width: 300px; text-align: center;">
        <h3>Update Cereal</h3>
        <form id="update-form">
            <div>
                <label for="cereal-name">Name:</label>
                <input type="text" id="cereal-name" name="name" />
            </div>
            <div>
                <label for="cereal-mfr">Manufacturer:</label>
                <input type="text" id="cereal-mfr" name="mfr" />
            </div>
            <div>
                <label for="cereal-type">Type:</label>
                <input type="text" id="cereal-type" name="type" />
            </div>
            <div>
                <label for="cereal-calories">Calories:</label>
                <input type="number" id="cereal-calories" name="calories" />
            </div>
            <div>
                <label for="cereal-protein">Protein:</label>
                <input type="number" id="cereal-protein" name="protein" />
            </div>
            <div>
                <label for="cereal-fat">Fat:</label>
                <input type="number" id="cereal-fat" name="fat" />
            </div>
            <div>
                <label for="cereal-sodium">Sodium:</label>
                <input type="number" id="cereal-sodium" name="sodium" />
            </div>
            <div>
                <label for="cereal-fiber">Fiber:</label>
                <input type="number" id="cereal-fiber" name="fiber" />
            </div>
            <div>
                <label for="cereal-carbo">Carbohydrates:</label>
                <input type="number" id="cereal-carbo" name="carbo" />
            </div>
            <div>
                <label for="cereal-sugar">Sugar (g):</label>
                <input type="number" id="cereal-sugar" name="sugar" />
            </div>
            <div>
                <label for="cereal-potass">Potassium:</label>
                <input type="number" id="cereal-potass" name="potass" />
            </div>
            <div>
                <label for="cereal-vitamins">Vitamins:</label>
                <input type="number" id="cereal-vitamins" name="vitamins" />
            </div>
            <div>
                <label for="cereal-shelf">Shelf:</label>
                <input type="number" id="cereal-shelf" name="shelf" />
            </div>
            <div>
                <label for="cereal-weight">Weight:</label>
                <input type="number" id="cereal-weight" name="weight" />
            </div>
            <div>
                <label for="cereal-cups">Cups:</label>
                <input type="number" id="cereal-cups" name="cups" />
            </div>
            <div>
                <label for="cereal-rating">Rating:</label>
                <input type="number" id="cereal-rating" name="rating" />
            </div>
            <div>
                <label for="cereal-image">Image URL:</label>
                <input type="text" id="cereal-image" name="image" />
            </div>
            <div style="margin-top: 10px;">
                <button type="button" id="save-update">Save</button>
                <button type="button" id="cancel-update">Cancel</button>
            </div>
        </form>
    </div>
</div>


<script>
    function fetchAndDisplayData(query = '') {
        const apiUrl = query
            ? `http://localhost:5203/cereal/Query/${query}`
            : "http://localhost:5203/cereal";


        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                return response.json();
            })
            .then(data => {
                const dataContainer = document.getElementById('data-container');
                let dataHTML = '';

                data.forEach(item => {
                    dataHTML += `<div class="item"><h2>${item.name}</h2><ul>`;

                    if (item.image != "No picture found") {
                        const imageUrl = `http://localhost:5203/cereal/image/${item.id}`;
                        dataHTML += `<img src="${imageUrl}" alt="${item.name}" class="item-image" />`;
                    }

                    for (const [key, value] of Object.entries(item)) {
                        dataHTML += `<li><strong>${key}:</strong> ${value}</li>`;
                    }

                    dataHTML += `
                            </ul>
                            <button onclick="deleteItem('${item.id}')">Delete</button>
                            <button onclick='showUpdateModal(${JSON.stringify(item)})'>Update</button>
                        </div>
                    `;

                });

                dataContainer.innerHTML = dataHTML;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('error-message').textContent = 'An error occurred when reading data';
            });
    }

    function deleteItem(id) {

        const userConfirmed = confirm("Are you sure you want to delete this cereal?");
        if (!userConfirmed) {
            return;
        }


        const apiUrl = `http://localhost:5203/cereal/${id}`;

        fetch(apiUrl, { method: 'DELETE' })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error deleting item');
                }
                alert('Item deleted successfully!');
                return fetchAndDisplayData();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete item.');
            });
    }

    function updateCereal(updatedCereal) {
        const apiUrl = `http://localhost:5203/cereal/${updatedCereal.id}`;

        fetch(apiUrl, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updatedCereal),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error updating item');
                }
                alert('Item updated successfully!');
                return fetchAndDisplayData();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update cereal.');
            });
    }

    function addCereal(newCereal) {
        const apiUrl = `http://localhost:5203/cereal`;

        fetch(apiUrl, {
            method: 'Post',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(newCereal),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error adding cereal');
                }
                alert('Cereal added successfully!');
                return fetchAndDisplayData();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to add cereal.');
            });
    }

    function showAddModal() {

        document.getElementById('add-cereal-name').value = ""
        document.getElementById('add-cereal-mfr').value = ""
        document.getElementById('add-cereal-type').value = ""
        document.getElementById('add-cereal-calories').value = 0
        document.getElementById('add-cereal-protein').value = 0
        document.getElementById('add-cereal-fat').value = 0
        document.getElementById('add-cereal-sodium').value = 0
        document.getElementById('add-cereal-fiber').value = 0
        document.getElementById('add-cereal-carbo').value = 0
        document.getElementById('add-cereal-sugar').value = 0
        document.getElementById('add-cereal-potass').value = 0
        document.getElementById('add-cereal-vitamins').value = 0
        document.getElementById('add-cereal-shelf').value = 0
        document.getElementById('add-cereal-weight').value = 0
        document.getElementById('add-cereal-cups').value = 0
        document.getElementById('add-cereal-rating').value = 0
        document.getElementById('add-cereal-image').value = "No picture found"

        const modal = document.getElementById('add-modal');
        modal.style.display = 'flex';

        document.getElementById('save-cereal').onclick = function () {
            const newCereal = {
                name: document.getElementById('add-cereal-name').value,
                mfr: document.getElementById('add-cereal-mfr').value,
                type: document.getElementById('add-cereal-type').value,
                calories: parseInt(document.getElementById('add-cereal-calories').value),
                protein: parseInt(document.getElementById('add-cereal-protein').value),
                fat: parseInt(document.getElementById('add-cereal-fat').value),
                sodium: parseInt(document.getElementById('add-cereal-sodium').value),
                fiber: parseInt(document.getElementById('add-cereal-fiber').value),
                carbo: parseInt(document.getElementById('add-cereal-carbo').value),
                sugar: parseInt(document.getElementById('add-cereal-sugar').value),
                potass: parseInt(document.getElementById('add-cereal-potass').value),
                vitamins: parseInt(document.getElementById('add-cereal-vitamins').value),
                shelf: parseInt(document.getElementById('add-cereal-shelf').value),
                weight: parseInt(document.getElementById('add-cereal-weight').value),
                cups: parseInt(document.getElementById('add-cereal-cups').value),
                rating: parseInt(document.getElementById('add-cereal-rating').value),
                image: document.getElementById('add-cereal-image').value,
            };

            modal.style.display = 'none';

            addCereal(newCereal);
        };

        document.getElementById('cancel-cereal').onclick = function () {
            modal.style.display = 'none';
        };
    }

    function showUpdateModal(cereal) {

        if (!cereal || typeof cereal !== 'object') {
            console.error('Invalid cereal object:', cereal);
            alert('Failed to load cereal data for update.');
            return;
        }
        console.log('Editing cereal:', cereal);

        document.getElementById('cereal-name').value = cereal.name;
        document.getElementById('cereal-mfr').value = cereal.mfr;
        document.getElementById('cereal-type').value = cereal.type;
        document.getElementById('cereal-calories').value = cereal.calories;
        document.getElementById('cereal-protein').value = cereal.protein;
        document.getElementById('cereal-fat').value = cereal.fat;
        document.getElementById('cereal-sodium').value = cereal.sodium;
        document.getElementById('cereal-fiber').value = cereal.fiber;
        document.getElementById('cereal-carbo').value = cereal.carbo;
        document.getElementById('cereal-sugar').value = cereal.sugar;
        document.getElementById('cereal-potass').value = cereal.potass;
        document.getElementById('cereal-vitamins').value = cereal.vitamins;
        document.getElementById('cereal-shelf').value = cereal.shelf;
        document.getElementById('cereal-weight').value = cereal.weight;
        document.getElementById('cereal-cups').value = cereal.cups;
        document.getElementById('cereal-rating').value = cereal.rating;
        document.getElementById('cereal-image').value = cereal.image;

        const modal = document.getElementById('update-modal');
        modal.style.display = 'flex';

        document.getElementById('save-update').onclick = function () {
            const updatedCereal = {
                id: cereal.id,
                name: document.getElementById('cereal-name').value,
                mfr: document.getElementById('cereal-mfr').value,
                type: document.getElementById('cereal-type').value,
                calories: parseInt(document.getElementById('cereal-calories').value),
                protein: parseInt(document.getElementById('cereal-protein').value),
                fat: parseInt(document.getElementById('cereal-fat').value),
                sodium: parseInt(document.getElementById('cereal-sodium').value),
                fiber: parseInt(document.getElementById('cereal-fiber').value),
                carbo: parseInt(document.getElementById('cereal-carbo').value),
                sugar: parseInt(document.getElementById('cereal-sugar').value),
                potass: parseInt(document.getElementById('cereal-potass').value),
                vitamins: parseInt(document.getElementById('cereal-vitamins').value),
                shelf: parseInt(document.getElementById('cereal-shelf').value),
                weight: parseInt(document.getElementById('cereal-weight').value),
                cups: parseInt(document.getElementById('cereal-cups').value),
                rating: parseInt(document.getElementById('cereal-rating').value),
                image: document.getElementById('cereal-image').value,
            };

            modal.style.display = 'none';

            updateCereal(updatedCereal);
        };

        document.getElementById('cancel-update').onclick = function () {
            modal.style.display = 'none';
        };
    }

    document.getElementById('add-cereal-button').addEventListener('click', () => {
        showAddModal()
    });


    document.getElementById("search-form").addEventListener("submit", (event) => {
        event.preventDefault();

        const query = document.getElementById("search-input").value.trim();
        fetchAndDisplayData(query);
    });

    fetchAndDisplayData();


</script>
</body>
</html>